name: Build tierkit-archive

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler:
          - { name: "clang-19", cc: "clang-19", cxx: "clang++-19", conan_compiler: "clang", conan_version: "19" }
          - { name: "clang-20", cc: "clang-20", cxx: "clang++-20", conan_compiler: "clang", conan_version: "20" }
        build_type: [Release, Debug]

    name: Build with ${{ matrix.compiler.name }} (${{ matrix.build_type }})

    steps:
      - uses: actions/checkout@v4

      - name: Setup user environment and install dependencies
        run: |
          # Create a normal user environment
          useradd -m -s /bin/bash builder
          
          # Setup CMake
          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
          echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ jammy main' | sudo tee /etc/apt/sources.list.d/kitware.list >/dev/null
          
          sudo apt-get update -q
          sudo apt-get install -y --no-install-recommends \
            cmake \
            ninja-build \
            python3-pip \
            wget \
            tar \
            coreutils \
            sudo

      - name: Install compiler toolchain
        run: |
          # Install LLVM/Clang
          wget -qO- https://apt.llvm.org/llvm.sh | sudo bash -s -- ${{ matrix.compiler.conan_version }}
          sudo apt-get install -y --no-install-recommends \
            libc++-${{ matrix.compiler.conan_version }}-dev \
            libc++abi-${{ matrix.compiler.conan_version }}-dev
          
          # Give builder user access to the project
          chown -R builder:builder /home/mj/workspace/hennypenny/tier1/tierkit-archive

      - name: Install Conan as builder user
        run: |
          sudo -u builder bash -c "
            cd /home/mj/workspace/hennypenny/tier1/tierkit-archive
            pip install --user 'conan>=2.0'
            ~/.local/bin/conan profile detect --force
          "

      - name: Configure Conan profile
        run: |
          sudo -u builder tee /home/builder/.conan2/profiles/default > /dev/null << EOF
          [settings]
          os=Linux
          arch=x86_64
          compiler=${{ matrix.compiler.conan_compiler }}
          compiler.version=${{ matrix.compiler.conan_version }}
          compiler.libcxx=libc++
          compiler.cppstd=23
          build_type=${{ matrix.build_type }}
          
          [buildenv]
          CC=${{ matrix.compiler.cc }}
          CXX=${{ matrix.compiler.cxx }}
          EOF

      - name: Build and test as builder user
        run: |
          sudo -u builder bash -c '
            cd /home/mj/workspace/hennypenny/tier1/tierkit-archive
            export PATH=$HOME/.local/bin:$PATH
            
            # Set compiler flags for Clang with libc++
            export CXXFLAGS="-stdlib=libc++"
            export LDFLAGS="-stdlib=libc++"
            
            echo "Building with ${{ matrix.compiler.name }} in ${{ matrix.build_type }} mode..."
            
            mkdir -p build
            
            echo "Installing dependencies with Conan..."
            conan install . --output-folder=build --build=missing \
              -s build_type=${{ matrix.build_type }} \
              -s compiler.cppstd=23 \
              -c tools.cmake.cmaketoolchain:generator="Ninja"
            
            # Find the toolchain file
            TOOLCHAIN_FILE=$(find build -name "conan_toolchain.cmake" | head -1)
            echo "Found toolchain at: $TOOLCHAIN_FILE"
            
            if [ -n "$TOOLCHAIN_FILE" ]; then
              TOOLCHAIN_ARG="-DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE"
            else
              echo "Warning: No toolchain file found, proceeding without Conan"
              TOOLCHAIN_ARG=""
            fi
            
            echo "Configuring with CMake..."
            cmake -B build -S . \
              -G Ninja \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DCMAKE_C_COMPILER=${{ matrix.compiler.cc }} \
              -DCMAKE_CXX_COMPILER=${{ matrix.compiler.cxx }} \
              -DCMAKE_CXX_STANDARD=23 \
              $TOOLCHAIN_ARG
              
            echo "Building..."
            cmake --build build -j$(nproc)
            
            echo "Running tests..."
            cd build
            ctest --output-on-failure -C ${{ matrix.build_type }} --verbose
          '

      - name: Upload build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.compiler.name }}-${{ matrix.build_type }}
          path: |
            build/Testing/Temporary/LastTest.log
            build/**/*.log

  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release package
        run: |
          mkdir -p release_package
          
          # Combine all compiler artifacts
          for compiler in clang-19 clang-20; do
            if [ -d "artifacts/library-${compiler}-Release" ]; then
              mkdir -p "release_package/${compiler}"
              cp -r "artifacts/library-${compiler}-Release"/* "release_package/${compiler}/"
            fi
          done
          
          # Create comprehensive release tarball
          tar -czf library-release-${{ github.ref_name }}.tar.gz release_package/
          
          # Create individual compiler packages
          cd artifacts
          for tarball in library-*-Release.tar.gz; do
            if [ -f "$tarball" ]; then
              cp "$tarball" ../
            fi
          done

      - name: Generate release notes
        run: |
          echo "# Release ${{ github.ref_name }}" > release_notes.md
          echo "" >> release_notes.md
          echo "## Supported Compilers" >> release_notes.md
          echo "- Clang 19, 20" >> release_notes.md
          echo "" >> release_notes.md
          echo "## C++ Standard" >> release_notes.md
          echo "- C++23" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Artifacts" >> release_notes.md
          echo "- \`library-release-${{ github.ref_name }}.tar.gz\`: Complete library package with all compiler variants" >> release_notes.md
          echo "- Individual compiler packages available for specific compiler requirements" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            library-release-${{ github.ref_name }}.tar.gz
            library-*-Release.tar.gz
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}